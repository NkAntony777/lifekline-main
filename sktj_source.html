<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>时刻天机</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { 
            max-width: 500px;
            margin-top: 50px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }
        table { width: 100%; margin-top: 15px; }
        td {
            padding: 15px;
            border: 1px solid #dee2e6;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        button { width: 100%; font-size: 18px; }
        
        /* 自定义干支下拉菜单的样式 */
        .form-select option[value="甲"], .form-select option[value="乙"] {
            color: #317023; /* 木 */
        }
        .form-select option[value="丙"], .form-select option[value="丁"] {
            color: #ce2d20; /* 火 */
        }
        .form-select option[value="戊"], .form-select option[value="己"] {
            color: #98511e; /* 土 */
        }
        .form-select option[value="庚"], .form-select option[value="辛"] {
            color: #e08433; /* 金 */
        }
        .form-select option[value="壬"], .form-select option[value="癸"] {
            color: #0803a8; /* 水 */
        }
        
        /* 地支的五行颜色 */
        .form-select option[value="子"], .form-select option[value="亥"] {
            color: #0803a8; /* 水 */
        }
        .form-select option[value="寅"], .form-select option[value="卯"] {
            color: #317023; /* 木 */
        }
        .form-select option[value="巳"], .form-select option[value="午"] {
            color: #ce2d20; /* 火 */
        }
        .form-select option[value="申"], .form-select option[value="酉"] {
            color: #e08433; /* 金 */
        }
        .form-select option[value="丑"], .form-select option[value="辰"], 
        .form-select option[value="未"], .form-select option[value="戌"] {
            color: #98511e; /* 土 */
        }
    </style>
    <script src="shensha.js"></script>
</head>
<body>
    <div class="container text-center">
        <h2 class="mb-3">时刻天机</h2>
        <div class="row mb-2">
            <div class="col-6">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="time-selection" id="current-time" checked>
                    <label class="form-check-label" for="current-time">当前时间</label>
                </div>
            </div>
            <div class="col-6">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="time-selection" id="random-number">
                    <label class="form-check-label" for="random-number">随机数起盘</label>
                </div>
            </div>
            
        </div>
        <div class="row mb-3">
            <div class="col-6">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="time-selection" id="custom-time">
                    <label class="form-check-label" for="custom-time">自定义时间</label>
                </div>
            </div>
            <div class="col-6">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="time-selection" id="custom-ganzhi">
                    <label class="form-check-label" for="custom-ganzhi">自定义干支</label>
                </div>
            </div>
            
        </div>

        <div id="custom-time-input" class="mt-3 d-none">
            <input type="datetime-local" id="custom-date" class="form-control">
        </div>

        <div id="random-number-input" class="mt-3 d-none">
            <div class="row g-2">
                <div class="col-8">
                    <input type="number" id="random-number-value" class="form-control" min="1" max="12" placeholder="输入1-12的数字">
                </div>
                <div class="col-4">
                    <button class="btn btn-primary w-100" onclick="generateRandomNumber()">随机生成</button>
                </div>
            </div>
        </div>

        <div id="custom-ganzhi-input" class="mt-3 d-none">
            <div class="row g-2 mb-2">
                <div class="col-3">
                    <label class="form-label">时干</label>
                    <select class="form-select" id="custom-hour-gan" onchange="updateZhiOptions('custom-hour-gan', 'custom-hour-zhi')">
                        <option value="甲">甲</option>
                        <option value="乙">乙</option>
                        <option value="丙">丙</option>
                        <option value="丁">丁</option>
                        <option value="戊">戊</option>
                        <option value="己">己</option>
                        <option value="庚">庚</option>
                        <option value="辛">辛</option>
                        <option value="壬">壬</option>
                        <option value="癸">癸</option>
                    </select>
                </div>
                <div class="col-3">
                    <label class="form-label">时支</label>
                    <select class="form-select" id="custom-hour-zhi">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="col-3">
                    <label class="form-label">刻干</label>
                    <select class="form-select" id="custom-ke-gan" onchange="updateZhiOptions('custom-ke-gan', 'custom-ke-zhi')">
                        <option value="甲">甲</option>
                        <option value="乙">乙</option>
                        <option value="丙">丙</option>
                        <option value="丁">丁</option>
                        <option value="戊">戊</option>
                        <option value="己">己</option>
                        <option value="庚">庚</option>
                        <option value="辛">辛</option>
                        <option value="壬">壬</option>
                        <option value="癸">癸</option>
                    </select>
                </div>
                <div class="col-3">
                    <label class="form-label">刻支</label>
                    <select class="form-select" id="custom-ke-zhi">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
            </div>
        </div>

        <button class="btn btn-success mt-3" onclick="calculate()">排盘</button>
        <div id="navigation-buttons" class="d-flex justify-content-between mt-4 d-none">
            <button class="btn btn-success btn-sm" style="width: 45%;" onclick="navigateToPrevious()">上一个盘</button>
            <button class="btn btn-success btn-sm" style="width: 45%;" onclick="navigateToNext()">下一个盘</button>
        </div>
        <table id="full-ganzhi" class="table table-bordered mt-3 d-none">
            <tr>
                <td class="table-primary">年柱</td>
                <td class="table-primary">月柱</td>
                <td class="table-primary">日柱</td>
                <td class="table-primary">时柱</td>
            </tr>
            <tr>
                <td id="year-ganzhi" style="width: 25%"></td>
                <td id="month-ganzhi" style="width: 25%"></td>
                <td id="day-ganzhi" style="width: 25%"></td>               
                <td id="hour-ganzhi" style="width: 25%"></td>
            </tr>
        </table>
        <table id="zodiac-table" class="table table-bordered mt-3 d-none">
            <tr><td class="table-primary"></td><td class="table-primary">时柱</td><td class="table-primary">刻柱</td></tr>
            <tr><td class="table-primary">十神</td><td id="self-label">我</td><td id="shishen"></td></tr>
            <tr><td class="table-primary">天干</td><td id="hour-gan"></td><td id="ke-gan"></td></tr>
            <tr><td class="table-primary">地支</td><td id="hour-zhi"></td><td id="ke-zhi"></td></tr>
            <tr><td class="table-primary">透干</td><td id="tougan-hour"></td><td id="tougan-ke"></td></tr>
            <tr><td class="table-primary">纳音</td><td id="nayin-hour"></td><td id="nayin-ke"></td></tr>
            <tr><td class="table-primary">十二长生</td><td id="shengxiao-hour"></td><td id="shengxiao-ke"></td></tr>
            <tr><td class="table-primary">旬空</td><td id="xunkong-hour"></td><td id="xunkong-ke"></td></tr>
                    
        </table>
        <table id="shensha-table" class="table table-bordered mt-3 d-none">
            <tr>
                <td class="table-primary text-center" colspan="3">天干神煞</td>
            </tr>
            <tbody id="tiangan-shensha-body"></tbody>
            <tr>
                <td class="table-primary text-center" colspan="3">地支神煞</td>
            </tr>
            <tbody id="dizhi-shensha-body"></tbody>
        </table>


    </div>
    <div class="container text-center">
        <p class="mt-4 text-muted">
            © 术数开发者：贺兰 | 软件开发者：白崖BaiCliff
        </p>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.min.js"></script>

    <script>
        // ================== 核心配置 ==================
        const WUXING_COLORS = {
            '甲': '#317023', '乙': '#317023',  // 木
            '丙': '#ce2d20', '丁': '#ce2d20',  // 火
            '戊': '#98511e', '己': '#98511e',  // 土
            '庚': '#e08433', '辛': '#e08433',  // 金
            '壬': '#0803a8', '癸': '#0803a8',  // 水
            '子': '#0803a8', '丑': '#98511e', '寅': '#317023',
            '卯': '#317023', '辰': '#98511e', '巳': '#ce2d20',
            '午': '#ce2d20', '未': '#98511e', '申': '#e08433',
            '酉': '#e08433', '戌': '#98511e', '亥': '#0803a8'
        };
        
        // 定义有效的六十甲子组合
        const VALID_GANZHI_PAIRS = [
            '甲子', '乙丑', '丙寅', '丁卯', '戊辰', '己巳', '庚午', '辛未', '壬申', '癸酉',
            '甲戌', '乙亥', '丙子', '丁丑', '戊寅', '己卯', '庚辰', '辛巳', '壬午', '癸未',
            '甲申', '乙酉', '丙戌', '丁亥', '戊子', '己丑', '庚寅', '辛卯', '壬辰', '癸巳',
            '甲午', '乙未', '丙申', '丁酉', '戊戌', '己亥', '庚子', '辛丑', '壬寅', '癸卯',
            '甲辰', '乙巳', '丙午', '丁未', '戊申', '己酉', '庚戌', '辛亥', '壬子', '癸丑',
            '甲寅', '乙卯', '丙辰', '丁巳', '戊午', '己未', '庚申', '辛酉', '壬戌', '癸亥'
        ];

        // 天干对应的地支映射（仅用于六十甲子限制）
        const GAN_TO_ZHI_MAP = {
            '甲': ['子', '寅', '辰', '午', '申', '戌'],
            '乙': ['丑', '卯', '巳', '未', '酉', '亥'],
            '丙': ['寅', '辰', '午', '申', '戌', '子'],
            '丁': ['卯', '巳', '未', '酉', '亥', '丑'],
            '戊': ['辰', '午', '申', '戌', '子', '寅'],
            '己': ['巳', '未', '酉', '亥', '丑', '卯'],
            '庚': ['午', '申', '戌', '子', '寅', '辰'],
            '辛': ['未', '酉', '亥', '丑', '卯', '巳'],
            '壬': ['申', '戌', '子', '寅', '辰', '午'],
            '癸': ['酉', '亥', '丑', '卯', '巳', '未']
        };
        
        // 旬空计算逻辑
        const xunKongMap = {};
        const tianGan = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸'];
        const diZhi = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
        
        for (let i = 0; i < 60; i++) {
            const ganIndex = i % 10;
            const zhiIndex = i % 12;
            const ganZhi = tianGan[ganIndex] + diZhi[zhiIndex];
            const xunIndex = Math.floor(i / 10);
            const xunKongPairs = ['戌、亥', '申、酉', '午、未', '辰、巳', '寅、卯', '子、丑'];
            xunKongMap[ganZhi] = xunKongPairs[xunIndex];
        }
        
        function getXunKong(ganZhi) {
            return xunKongMap[ganZhi] || '未知';
        }

        const TWELVE_LONGEVITY = [
            '长生', '沐浴', '冠带', '临官', '帝旺', 
            '衰', '病', '死', '墓', '绝', '胎', '养'
        ];

        const tenHeavenlyStemsLongevityTable = {
            "甲": ["亥", "子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌"],
            "乙": ["亥", "子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌"],
            "丙": ["寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥", "子", "丑"],
            "丁": ["寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥", "子", "丑"],
            "戊": ["申", "酉", "戌", "亥", "子", "丑", "寅", "卯", "辰", "巳", "午", "未"],
            "己": ["申", "酉", "戌", "亥", "子", "丑", "寅", "卯", "辰", "巳", "午", "未"],
            "庚": ["巳", "午", "未", "申", "酉", "戌", "亥", "子", "丑", "寅", "卯", "辰"],
            "辛": ["巳", "午", "未", "申", "酉", "戌", "亥", "子", "丑", "寅", "卯", "辰"],
            "壬": ["申", "酉", "戌", "亥", "子", "丑", "寅", "卯", "辰", "巳", "午", "未"],
            "癸": ["申", "酉", "戌", "亥", "子", "丑", "寅", "卯", "辰", "巳", "午", "未"]
        };

        // 创建反向查询字典
        const longevityMap = {};
        Object.entries(tenHeavenlyStemsLongevityTable).forEach(([gan, zhiList]) => {
            longevityMap[gan] = {};
            zhiList.forEach((zhi, index) => {
                longevityMap[gan][zhi] = TWELVE_LONGEVITY[index];
            });
        });

        const NAYIN_MAP = {
            '甲子':'海中金', '乙丑':'海中金', '丙寅':'炉中火', '丁卯':'炉中火',
            '戊辰':'大林木', '己巳':'大林木', '庚午':'路旁土', '辛未':'路旁土',
            '壬申':'剑锋金', '癸酉':'剑锋金', '甲戌':'山头火', '乙亥':'山头火',
            '丙子':'洞下水', '丁丑':'洞下水', '戊寅':'城头土', '己卯':'城头土',
            '庚辰':'白蜡金', '辛巳':'白蜡金', '壬午':'杨柳木', '癸未':'杨柳木',
            '甲申':'泉中水', '乙酉':'泉中水', '丙戌':'屋上土', '丁亥':'屋上土',
            '戊子':'霹雳火', '己丑':'霹雳火', '庚寅':'松柏木', '辛卯':'松柏木',
            '壬辰':'长流水', '癸巳':'长流水', '甲午':'砂中金', '乙未':'砂中金',
            '丙申':'山下火', '丁酉':'山下火', '戊戌':'平地木', '己亥':'平地木',
            '庚子':'壁上土', '辛丑':'壁上土', '壬寅':'金箔金', '癸卯':'金箔金',
            '甲辰':'覆灯火', '乙巳':'覆灯火', '丙午':'天河水', '丁未':'天河水',
            '戊申':'大驿土', '己酉':'大驿土', '庚戌':'钗钏金', '辛亥':'钗钏金',
            '壬子':'桑柘木', '癸丑':'桑柘木', '甲寅':'大溪水', '乙卯':'大溪水',
            '丙辰':'沙中土', '丁巳':'沙中土', '戊午':'天上火', '己未':'天上火',
            '庚申':'石榴木', '辛酉':'石榴木', '壬戌':'大海水', '癸亥':'大海水'
        };

        const TOUGAN_MAP = {
            '子': ['癸'],
            '丑': ['己','癸','辛'],
            '寅': ['甲','丙','戊'],
            '卯': ['乙'],
            '辰': ['戊','乙','癸'],
            '巳': ['丙','庚','戊'],
            '午': ['丁','己'],
            '未': ['己','丁','乙'],
            '申': ['庚','壬','戊'],
            '酉': ['辛'],
            '戌': ['戊','辛','丁'],
            '亥': ['壬','甲']
        };

        const SHISHEN_MAP = {
            '甲': {甲:'比肩',乙:'劫财',丙:'食神',丁:'伤官',戊:'偏财',己:'正财',庚:'七杀',辛:'正官',壬:'偏印',癸:'正印'},
            '乙': {甲:'劫财',乙:'比肩',丙:'伤官',丁:'食神',戊:'正财',己:'偏财',庚:'正官',辛:'七杀',壬:'正印',癸:'偏印'},
            '丙': {甲:'偏印',乙:'正印',丙:'比肩',丁:'劫财',戊:'食神',己:'伤官',庚:'偏财',辛:'正财',壬:'七杀',癸:'正官'},
            '丁': {甲:'正印',乙:'偏印',丙:'劫财',丁:'比肩',戊:'伤官',己:'食神',庚:'正财',辛:'偏财',壬:'正官',癸:'七杀'},
            '戊': {甲:'七杀',乙:'正官',丙:'偏印',丁:'正印',戊:'比肩',己:'劫财',庚:'食神',辛:'伤官',壬:'偏财',癸:'正财'},
            '己': {甲:'正官',乙:'七杀',丙:'正印',丁:'偏印',戊:'劫财',己:'比肩',庚:'伤官',辛:'食神',壬:'正财',癸:'偏财'},
            '庚': {甲:'偏财',乙:'正财',丙:'七杀',丁:'正官',戊:'偏印',己:'正印',庚:'比肩',辛:'劫财',壬:'食神',癸:'伤官'},
            '辛': {甲:'正财',乙:'偏财',丙:'正官',丁:'七杀',戊:'正印',己:'偏印',庚:'劫财',辛:'比肩',壬:'伤官',癸:'食神'},
            '壬': {甲:'食神',乙:'伤官',丙:'偏财',丁:'正财',戊:'七杀',己:'正官',庚:'偏印',辛:'正印',壬:'比肩',癸:'劫财'},
            '癸': {甲:'伤官',乙:'食神',丙:'正财',丁:'偏财',戊:'正官',己:'七杀',庚:'正印',辛:'偏印',壬:'劫财',癸:'比肩'}
        };

        const naYinColors = {
            '金': '#e08433',
            '木': '#317023',
            '水': '#0803a8',
            '火': '#ce2d20',
            '土': '#98511e'
        };
        const tianganShensha = {
            "贵人": { "甲": "丑、未", "乙": "子、申", "丙": "亥、酉", "丁": "亥、酉", "戊": "丑、未", "己": "子、申", "庚": "丑、未", "辛": "寅、午", "壬": "卯、巳", "癸": "卯、巳" },
            "沐浴": { "甲": "亥", "乙": "亥", "丙": "卯", "丁": "卯", "戊": "酉", "己": "酉", "庚": "午", "辛": "午", "壬": "酉", "癸": "酉" },
            "干禄": { "甲": "寅", "乙": "卯", "丙": "巳", "丁": "午", "戊": "巳", "己": "午", "庚": "申", "辛": "酉", "壬": "亥", "癸": "子" },
            "羊刃": { "甲": "卯", "乙": "辰", "丙": "午", "丁": "未", "戊": "午", "己": "未", "庚": "酉", "辛": "戌", "壬": "子", "癸": "丑" },
            "飞刃": { "甲": "酉", "乙": "戌", "丙": "子", "丁": "丑", "戊": "子", "己": "丑", "庚": "卯", "辛": "辰", "壬": "午", "癸": "未" },
            "红艳": { "甲": "午", "乙": "未", "丙": "申", "丁": "酉", "戊": "辰", "己": "巳", "庚": "子", "辛": "丑", "壬": "寅", "癸": "卯" },
            "金舆": { "甲": "辰", "乙": "未", "丙": "未", "丁": "未", "戊": "辰", "己": "辰", "庚": "未", "辛": "未", "壬": "戌", "癸": "戌" },
            "学堂": {"甲": "亥","乙": "亥","丙": "寅","丁": "寅","戊": "申","己": "申","庚": "巳","辛": "巳","壬": "申","癸": "申"}
        };
        
        const dizhiShensha = {
            "驿马": { "子": "寅", "丑": "卯", "寅": "申", "卯": "巳", "辰": "寅", "巳": "亥", "午": "申", "未": "巳", "申": "寅", "酉": "亥", "戌": "申", "亥": "巳" },
            "华盖": { "子": "辰", "丑": "丑", "寅": "戌", "卯": "未", "辰": "辰", "巳": "丑", "午": "戌", "未": "未", "申": "辰", "酉": "丑", "戌": "戌", "亥": "未" },
            "桃花": { "申": "酉", "子": "酉", "辰": "酉", "寅": "卯", "午": "卯", "戌": "卯", "巳": "午", "酉": "午", "丑": "午", "亥": "子", "卯": "子", "未": "子"},
            "红鸾": { "子": "卯", "丑": "寅", "寅": "丑", "卯": "子", "辰": "亥", "巳": "戌", "午": "酉", "未": "申", "申": "未", "酉": "午", "戌": "巳", "亥": "辰" },
            "天喜": { "子": "酉", "丑": "申", "寅": "未", "卯": "午", "辰": "巳", "巳": "辰", "午": "卯", "未": "寅", "申": "丑", "酉": "子", "戌": "亥", "亥": "戌" },
            "孤辰": { "子": "寅", "丑": "寅", "寅": "巳", "卯": "巳", "辰": "巳", "巳": "申", "午": "申", "未": "申", "申": "亥", "酉": "亥", "戌": "亥", "亥": "寅" },
            "寡宿": { "子": "戌", "丑": "戌", "寅": "丑", "卯": "丑", "辰": "丑", "巳": "辰", "午": "辰", "未": "辰", "申": "未", "酉": "未", "戌": "未", "亥": "戌" },
            "亡神": { "寅": "巳", "午": "巳", "戌": "巳", "亥": "寅", "卯": "寅", "未": "寅", "巳": "申", "酉": "申", "丑": "申", "申": "亥", "子": "亥", "辰": "亥" },
            "劫煞": { "子": "巳", "丑": "寅", "寅": "亥", "卯": "申", "辰": "巳", "巳": "寅", "午": "巳", "未": "亥", "申": "巳", "酉": "寅", "戌": "亥", "亥": "申" },
            "丧门": { "子": "寅", "丑": "卯", "寅": "辰", "卯": "巳", "辰": "午", "巳": "未", "午": "申", "未": "酉", "申": "戌", "酉": "亥", "戌": "子", "亥": "丑" },
            "吊客": { "子": "戌", "丑": "亥", "寅": "子", "卯": "丑", "辰": "寅", "巳": "卯", "午": "辰", "未": "巳", "申": "午", "酉": "未", "戌": "申", "亥": "酉" }
        };

        function setStyledCell(id, value) {
            const element = document.getElementById(id);
            if (!element) return;

            element.innerHTML = value.split(/[、,]/).map(c => {
                const color = WUXING_COLORS[c] || '#666';
                return `<span style="color: ${color}">${c}</span>`;
            }).join('、');
        }


        // ================== 核心算法 ==================
        function getKeInfo(date) {
            const lunar = Lunar.fromDate(date);
            const shiZhi = lunar.getTimeZhi();

            const zhiStartHourMap = {
                '子':23, '丑':1, '寅':3, '卯':5, '辰':7, '巳':9,
                '午':11, '未':13, '申':15, '酉':17, '戌':19, '亥':21
            };
            const startHour = zhiStartHourMap[shiZhi];

            const startDate = new Date(date);
            if (date.getHours() >= startHour) {
                startDate.setHours(startHour, 0, 0, 0);
            } else {
                startDate.setDate(startDate.getDate() - 1);
                startDate.setHours(startHour, 0, 0, 0);
            }

            const diffMs = date - startDate;
            const totalMinutes = Math.floor(diffMs / 1000 / 60);
            let keIndex = Math.floor(totalMinutes / 10);
            if (keIndex < 0) keIndex = 0;
            if (keIndex > 11) keIndex = 11;

            const keSequence = ['子','丑','寅','卯','辰','巳','午','未','申','酉','戌','亥'];
            return {
                keZhi: keSequence[keIndex],
                keIndex: keIndex
            };
        }

        function getKeGan(shiGan, keIndex) {
            // 五子遁元口诀
            const starters = {
                '甲':0, '己':0,   // 甲子
                '乙':2, '庚':2,   // 丙子
                '丙':4, '辛':4,   // 戊子
                '丁':6, '壬':6,   // 庚子
                '戊':8, '癸':8    // 壬子
            };
            const gans = ['甲','乙','丙','丁','戊','己','庚','辛','壬','癸'];
            return gans[(starters[shiGan] + keIndex) % 10];
        }

        // ================== 主逻辑 ==================
        function calculate() {
            if (document.getElementById('custom-ganzhi').checked) {
                calculateFromCustomGanzhi();
                return;
            }
            
            if (document.getElementById('random-number').checked) {
                calculateFromRandomNumber();
                return;
            }
            
            const date = getSelectedDate();
            const lunar = Lunar.fromDate(date);
            
            // 获取时柱信息
            const timeGanZhi = lunar.getTimeInGanZhi();
            const shiGan = timeGanZhi[0];
            const shiZhi = timeGanZhi[1];
            const yearGanzhi = lunar.getYearInGanZhi();
            const monthGanzhi = lunar.getMonthInGanZhi();
            const dayGanzhi = lunar.getDayInGanZhi();

            // 计算刻柱
            const { keZhi, keIndex } = getKeInfo(date);
            const keGan = getKeGan(shiGan, keIndex);
            
            // 计算旬空
            const hourGanZhi = shiGan + shiZhi;
            const keGanZhi = keGan + keZhi;
            
            const xunkongHour = getXunKong(hourGanZhi);
            const xunkongKe = getXunKong(keGanZhi);

            
            // 计算十二长生
            const shengxiaoHour = getLongevity(shiGan, shiZhi);
            const shengxiaoKe = getLongevity(keGan, keZhi);

            // 更新界面
            updateDisplay({
                shiGan, 
                shiZhi,
                keGan, 
                keZhi,
                shengxiaoHour,
                shengxiaoKe,
                yearGanzhi,
                monthGanzhi,
                dayGanzhi,
                hourGanzhi: timeGanZhi,
                nayinHour: NAYIN_MAP[shiGan + shiZhi] || '未知',
                nayinKe: NAYIN_MAP[keGan + keZhi] || '未知',
                shishen: SHISHEN_MAP[shiGan]?.[keGan] || '未知',
                touganHour: TOUGAN_MAP[shiZhi] || [],
                touganKe: TOUGAN_MAP[keZhi] || [],
                xunkongHour,
                xunkongKe
            });
            // 更新神煞显示
            updateShenshaDisplay(shiGan, shiZhi, keGan, keZhi);
            document.getElementById('shensha-table').classList.remove('d-none');
            
            // 显示导航按钮
            document.getElementById('navigation-buttons').classList.remove('d-none');
        }

        function calculateFromCustomGanzhi() {
            // 从自定义干支输入获取值
            const shiGan = document.getElementById('custom-hour-gan').value;
            const shiZhi = document.getElementById('custom-hour-zhi').value;
            const keGan = document.getElementById('custom-ke-gan').value;
            const keZhi = document.getElementById('custom-ke-zhi').value;
            
            // 直接使用通用的干支计算函数
            calculateFromGanzhi(shiGan, shiZhi, keGan, keZhi);
        }

        function calculateFromRandomNumber() {
            // 获取随机数（1-12）
            const randomNumInput = document.getElementById('random-number-value');
            let randomNum = parseInt(randomNumInput.value);
            
            // 验证输入是否在1-12范围内
            if (isNaN(randomNum) || randomNum < 1 || randomNum > 12) {
                alert('请输入1-12之间的数字');
                return;
            }
            
            // 获取当前时间（用于时柱信息）
            const date = new Date();
            const lunar = Lunar.fromDate(date);
            
            // 获取时柱信息
            const timeGanZhi = lunar.getTimeInGanZhi();
            const shiGan = timeGanZhi[0];
            const shiZhi = timeGanZhi[1];
            
            // 将1-12的数字映射到地支（子=1，丑=2，...，亥=12）
            const keIndex = randomNum - 1;
            const keZhi = diZhi[keIndex];
            
            // 根据时干和刻支索引计算刻干
            const keGan = getKeGan(shiGan, keIndex);
            
            // 直接使用通用的干支计算函数
            calculateFromGanzhi(shiGan, shiZhi, keGan, keZhi);
        }

        // ================== 工具函数 ==================
        function getSelectedDate() {
            if (document.getElementById('custom-time').checked) {
                return new Date(document.getElementById('custom-date').value);
            }
            return new Date();
        }
        
        function getLongevity(gan, zhi) {
            return longevityMap[gan]?.[zhi] || '未知';
        }

        function updateDisplay(data) {
            // 时柱信息
            setCell('hour-gan', data.shiGan);
            setCell('hour-zhi', data.shiZhi);
            
            // 根据数据决定是否显示完整八字
            if (data.showFullBazi || document.getElementById('current-time').checked || 
                document.getElementById('custom-time').checked) {
                setGanzhiColor('year-ganzhi', data.yearGanzhi);
                setGanzhiColor('month-ganzhi', data.monthGanzhi);
                setGanzhiColor('day-ganzhi', data.dayGanzhi);
                setGanzhiColor('hour-ganzhi', data.hourGanzhi);
                document.getElementById('full-ganzhi').classList.remove('d-none');
            } else {
                document.getElementById('full-ganzhi').classList.add('d-none');
            }
            
            // 刻柱信息
            setCell('ke-gan', data.keGan);
            setCell('ke-zhi', data.keZhi);

            // 十二长生显示
            setLongevity('shengxiao-hour', data.shengxiaoHour, data.shiZhi);
            setLongevity('shengxiao-ke', data.shengxiaoKe, data.keZhi);
            
            // 其他数据
            setNaYinColor('nayin-hour', data.nayinHour);
            setNaYinColor('nayin-ke', data.nayinKe);
            setShishenColor('shishen', data.shishen, data.keGan);
            setShishenColor('self-label', '我', data.shiGan);
            setStyledTougan('tougan-hour', data.touganHour);
            setStyledTougan('tougan-ke', data.touganKe);
            
            // 更新旬空数据
            setStyledCell('xunkong-hour', data.xunkongHour);
            setStyledCell('xunkong-ke', data.xunkongKe);
            
            document.getElementById('zodiac-table').classList.remove('d-none');
        }

        function setShishenColor(id, text, gan) {
            const element = document.getElementById(id);
            const color = WUXING_COLORS[gan] || '#000';

            element.innerHTML = `<span style="color: ${color}">${text}</span>`;
        }

        function setCell(id, text) {
            const element = document.getElementById(id);
            element.textContent = text;
            element.style.color = WUXING_COLORS[text] || '#000';
        }

        function setNaYinColor(elementId, nayin) {
            const element = document.getElementById(elementId);
            const lastChar = nayin?.slice(-1);
            element.textContent = nayin;
            element.style.color = lastChar ? naYinColors[lastChar] : '#000';
        }

        function setStyledTougan(id, ganzhi) {
            const element = document.getElementById(id);
            element.innerHTML = ganzhi?.map(c => 
                `<span style="color: ${WUXING_COLORS[c]}">${c}</span>`
            ).join('、') || '无';
        }
        
        function setLongevity(id, text, zhi) {
            const element = document.getElementById(id);
            element.innerHTML = `<span style="color: ${WUXING_COLORS[zhi]}">${text}</span>`;
        }

        // 新增的干支着色函数
        function setGanzhiColor(elementId, ganzhi) {
            const element = document.getElementById(elementId);
            element.innerHTML = Array.from(ganzhi).map(c => 
                `<span style="color: ${WUXING_COLORS[c]}">${c}</span>`
            ).join('');
        }

        // ================== 事件监听 ==================
        document.getElementById('custom-time').addEventListener('change', () => {
            document.getElementById('custom-time-input').classList.toggle('d-none', !document.getElementById('custom-time').checked);
            document.getElementById('custom-ganzhi-input').classList.add('d-none');
            document.getElementById('random-number-input').classList.add('d-none');
        });
        
        document.getElementById('custom-ganzhi').addEventListener('change', () => {
            document.getElementById('custom-ganzhi-input').classList.toggle('d-none', !document.getElementById('custom-ganzhi').checked);
            document.getElementById('custom-time-input').classList.add('d-none');
            document.getElementById('random-number-input').classList.add('d-none');
        });

        document.getElementById('random-number').addEventListener('change', () => {
            document.getElementById('random-number-input').classList.toggle('d-none', !document.getElementById('random-number').checked);
            document.getElementById('custom-time-input').classList.add('d-none');
            document.getElementById('custom-ganzhi-input').classList.add('d-none');
        });

        document.getElementById('current-time').addEventListener('change', () => {
            document.getElementById('custom-time-input').classList.add('d-none');
            document.getElementById('custom-ganzhi-input').classList.add('d-none');
            document.getElementById('random-number-input').classList.add('d-none');
        });

        function generateRandomNumber() {
            const randomInput = document.getElementById('random-number-value');
            randomInput.value = Math.floor(Math.random() * 12) + 1;
        }

        function ensureTableExists(tableId, title, columnTitle, hourValue, keValue) {
            let table = document.getElementById(tableId);
            if (!table) {
                table = document.createElement('table');
                table.id = tableId;
                table.className = 'table table-bordered mt-3';
                document.body.appendChild(table);
            }
            const coloredHourValue = colorizeShensha(hourValue);
            const coloredKeValue = colorizeShensha(keValue);
            // 设置表头第一行为当前时干或刻干
            table.innerHTML = `
                <tr>
                    <td class="shensha-label table-primary">${title}</td>
                    <td class="shensha-label table-primary">${coloredHourValue}</td>
                    <td class="shensha-label table-primary">${coloredKeValue}</td>
                </tr>`;
            return table;
        }

        function updateShenshaDisplay(hourGan, hourZhi, keGan, keZhi) {
            const shenshaTable = document.getElementById('shensha-table');
            shenshaTable.innerHTML = `
                <tbody>
                    <tr>
                        <td class="table-primary">天干神煞</td>
                        <td class="table-primary" style="color: ${WUXING_COLORS[hourGan] || '#000'};">${hourGan}</td>
                        <td class="table-primary" style="color: ${WUXING_COLORS[keGan] || '#000'};">${keGan}</td>
                    </tr>
                </tbody>
            `;
            const tbody = shenshaTable.querySelector('tbody');

            // 天干神煞部分（顺序：贵人、干禄、羊刃、红艳、金舆）
            const tianganTypes = ['贵人', '干禄', '羊刃','飞刃', '红艳', '金舆','学堂'];
            tianganTypes.forEach(type => {
                const row = document.createElement('tr');
                // 这里根据时柱取天干神煞信息，刻柱取天干神煞（也可根据需要调整规则）
                const hourValue = colorizeShensha(tianganShensha[type]?.[hourGan] || '');
                const keValue = colorizeShensha(tianganShensha[type]?.[keGan] || '');
                row.innerHTML = `<td class="table-primary">${type}</td><td>${hourValue || '—'}</td><td>${keValue || '—'}</td>`;
                tbody.appendChild(row);
            });

            // 插入地支神煞分隔行
            const separator = document.createElement('tr');
            separator.className = 'table-secondary';
            tbody.appendChild(separator);

            // 新增地支信息行
            const dizhiHeader = document.createElement('tr');
            dizhiHeader.innerHTML = `<td class="table-primary">地支神煞</td><td class="table-primary" style="color: ${WUXING_COLORS[hourZhi] || '#000'};">${hourZhi}</td><td class="table-primary" style="color: ${WUXING_COLORS[keZhi] || '#000'};">${keZhi}</td>`;
            tbody.appendChild(dizhiHeader);

            // 地支神煞部分（顺序：驿马、华盖、桃花、劫煞、红鸾、天喜、孤辰、寡宿、将星）
            const dizhiTypes = ['驿马', '华盖', '桃花', '红鸾', '天喜', '孤辰', '寡宿', '亡神', '劫煞','丧门','吊客'];
            dizhiTypes.forEach(type => {
                const row = document.createElement('tr');
                // 地支神煞根据时柱和刻柱取对应信息
                const hourValue = colorizeShensha(dizhiShensha[type]?.[hourZhi] || '');
                const keValue = colorizeShensha(dizhiShensha[type]?.[keZhi] || '');
                row.innerHTML = `<td class="table-primary">${type}</td><td>${hourValue || '—'}</td><td>${keValue || '—'}</td>`;
                tbody.appendChild(row);
            });

            shenshaTable.classList.remove('d-none');
        }

        function appendShenshaRow(table, type, hourValue, keValue) {
            const row = table.insertRow();
            row.innerHTML = `
                <td class="shensha-label table-primary">${type}</td>
                <td>${hourValue}</td>
                <td>${keValue}</td>`;
        }

        function colorizeShensha(text) {
            if (!text) return '';
            return text.split(/[、,]/).map(c => {
                const color = WUXING_COLORS[c] || '#000';
                return `<span style="color: ${color}">${c}</span>`;
            }).join('、');
        }

        function setStyledCell(id, value) {
            const element = document.getElementById(id);
            if (!element) return;
            
            element.innerHTML = String(value).split(/[、,]/).map(c => {
                const color = WUXING_COLORS[c] || '#666';
                return `<span style="color: ${color}">${c}</span>`;
            }).join('、');
        }

        function updateZhiOptions(ganId, zhiId) {
            const gan = document.getElementById(ganId).value;
            const zhiSelect = document.getElementById(zhiId);
            zhiSelect.innerHTML = '';
            
            // 获取该天干对应的有效地支
            const validZhis = GAN_TO_ZHI_MAP[gan] || [];
            
            validZhis.forEach(zhi => {
                const option = document.createElement('option');
                option.value = zhi;
                option.textContent = zhi;
                // 设置五行颜色
                option.style.color = WUXING_COLORS[zhi] || '#000';
                zhiSelect.appendChild(option);
            });
        }

        // 页面加载时初始化地支选项
        window.addEventListener('DOMContentLoaded', function() {
            // 初始化时辰地支选项
            updateZhiOptions('custom-hour-gan', 'custom-hour-zhi');
            // 初始化刻钟地支选项
            updateZhiOptions('custom-ke-gan', 'custom-ke-zhi');
        });

        // 获取时柱信息
        function getTimeInfo() {
            // 取得当前界面上的时干时支
            const shiGan = document.getElementById('hour-gan').textContent;
            const shiZhi = document.getElementById('hour-zhi').textContent;
            const keGan = document.getElementById('ke-gan').textContent;
            const keZhi = document.getElementById('ke-zhi').textContent;
            
            return { shiGan, shiZhi, keGan, keZhi };
        }
        
        // 导航到下一个盘
        function navigateToNext() {
            const { shiGan, shiZhi, keGan, keZhi } = getTimeInfo();
            
            // 获取当前刻支的索引
            let keZhiIndex = diZhi.indexOf(keZhi);
            let shiZhiIndex = diZhi.indexOf(shiZhi);
            
            // 刻支向后移动一位
            keZhiIndex = (keZhiIndex + 1) % 12;
            const newKeZhi = diZhi[keZhiIndex];
            
            // 当刻支循环到子时，时支向后移动一位
            let newShiZhi = shiZhi;
            let newShiGan = shiGan;
            
            if (keZhi === '亥' && newKeZhi === '子') {
                shiZhiIndex = (shiZhiIndex + 1) % 12;
                newShiZhi = diZhi[shiZhiIndex];
                
                // 找出当前的时干在天干列表中的索引
                const shiGanIndex = tianGan.indexOf(shiGan);
                // 天干向后移动一位（循环）
                const newShiGanIndex = (shiGanIndex + 1) % 10;
                newShiGan = tianGan[newShiGanIndex];
                
                // 检查组合是否有效，如果无效则调整
                if (!VALID_GANZHI_PAIRS.includes(newShiGan + newShiZhi)) {
                    // 尝试找到与新时支匹配的有效时干
                    for (let i = 0; i < tianGan.length; i++) {
                        const testGan = tianGan[i];
                        if (VALID_GANZHI_PAIRS.includes(testGan + newShiZhi)) {
                            newShiGan = testGan;
                            break;
                        }
                    }
                }
            }
            
            // 获取当前的年月日柱（如果存在）
            const yearGanzhi = document.getElementById('year-ganzhi').textContent || '';
            const monthGanzhi = document.getElementById('month-ganzhi').textContent || '';
            const dayGanzhi = document.getElementById('day-ganzhi').textContent || '';
            
            // 根据时干和新的刻支索引计算新的刻干
            const newKeIndex = keZhiIndex;
            const newKeGan = getKeGan(newShiGan, newKeIndex);
            
            // 设置新的值并重新计算
            calculateFromGanzhi(newShiGan, newShiZhi, newKeGan, newKeZhi, yearGanzhi, monthGanzhi, dayGanzhi);
        }
        
        // 导航到上一个盘
        function navigateToPrevious() {
            const { shiGan, shiZhi, keGan, keZhi } = getTimeInfo();
            
            // 获取当前刻支的索引
            let keZhiIndex = diZhi.indexOf(keZhi);
            let shiZhiIndex = diZhi.indexOf(shiZhi);
            
            // 刻支向前移动一位
            keZhiIndex = (keZhiIndex - 1 + 12) % 12;  // 加12是为了确保不会出现负数
            const newKeZhi = diZhi[keZhiIndex];
            
            // 当刻支循环到亥时，时支向前移动一位
            let newShiZhi = shiZhi;
            let newShiGan = shiGan;
            
            if (keZhi === '子' && newKeZhi === '亥') {
                shiZhiIndex = (shiZhiIndex - 1 + 12) % 12;  // 加12是为了确保不会出现负数
                newShiZhi = diZhi[shiZhiIndex];
                
                // 找出当前的时干在天干列表中的索引
                const shiGanIndex = tianGan.indexOf(shiGan);
                // 天干向前移动一位（循环）
                const newShiGanIndex = (shiGanIndex - 1 + 10) % 10;
                newShiGan = tianGan[newShiGanIndex];
                
                // 检查组合是否有效，如果无效则调整
                if (!VALID_GANZHI_PAIRS.includes(newShiGan + newShiZhi)) {
                    // 尝试找到与新时支匹配的有效时干
                    for (let i = tianGan.length - 1; i >= 0; i--) {
                        const testGan = tianGan[i];
                        if (VALID_GANZHI_PAIRS.includes(testGan + newShiZhi)) {
                            newShiGan = testGan;
                            break;
                        }
                    }
                }
            }
            
            // 获取当前的年月日柱（如果存在）
            const yearGanzhi = document.getElementById('year-ganzhi').textContent || '';
            const monthGanzhi = document.getElementById('month-ganzhi').textContent || '';
            const dayGanzhi = document.getElementById('day-ganzhi').textContent || '';
            
            // 根据时干和新的刻支索引计算新的刻干
            const newKeIndex = keZhiIndex;
            const newKeGan = getKeGan(newShiGan, newKeIndex);
            
            // 设置新的值并重新计算
            calculateFromGanzhi(newShiGan, newShiZhi, newKeGan, newKeZhi, yearGanzhi, monthGanzhi, dayGanzhi);
        }
        
        // 根据给定的干支进行计算
        function calculateFromGanzhi(shiGan, shiZhi, keGan, keZhi, yearGanzhi='', monthGanzhi='', dayGanzhi='') {
            // 计算旬空
            const hourGanZhi = shiGan + shiZhi;
            const keGanZhi = keGan + keZhi;
            
            const xunkongHour = getXunKong(hourGanZhi);
            const xunkongKe = getXunKong(keGanZhi);
            
            // 计算十二长生
            const shengxiaoHour = getLongevity(shiGan, shiZhi);
            const shengxiaoKe = getLongevity(keGan, keZhi);
            
            // 确定是否显示完整八字
            const showFullBazi = document.getElementById('current-time').checked || 
                              document.getElementById('custom-time').checked ||
                              (yearGanzhi && monthGanzhi && dayGanzhi);
            
            // 更新界面显示
            updateDisplay({
                shiGan, 
                shiZhi,
                keGan, 
                keZhi,
                shengxiaoHour,
                shengxiaoKe,
                yearGanzhi,
                monthGanzhi,
                dayGanzhi,
                hourGanzhi: shiGan + shiZhi,
                nayinHour: NAYIN_MAP[shiGan + shiZhi] || '未知',
                nayinKe: NAYIN_MAP[keGan + keZhi] || '未知',
                shishen: SHISHEN_MAP[shiGan]?.[keGan] || '未知',
                touganHour: TOUGAN_MAP[shiZhi] || [],
                touganKe: TOUGAN_MAP[keZhi] || [],
                xunkongHour,
                xunkongKe,
                showFullBazi
            });
            
            // 更新神煞显示
            updateShenshaDisplay(shiGan, shiZhi, keGan, keZhi);
            document.getElementById('shensha-table').classList.remove('d-none');
            
            // 显示导航按钮
            document.getElementById('navigation-buttons').classList.remove('d-none');
        }

    </script>
</body>
</html>
